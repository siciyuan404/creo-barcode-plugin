# Creo 条形码插件 - 图片插入说明

## 版本信息
- **版本**: 2.0 (优化版)
- **编译时间**: 2025-12-22
- **DLL 位置**: `build_dll/bin/Release/creo_barcode.dll`

## 主要改进

### 1. 条形码生成优化
- ✅ 提高了条形码质量（最小模块宽度从 1 像素增加到 2 像素）
- ✅ 优化了默认尺寸：400x120 像素（原 300x100）
- ✅ 增加了边距：20 像素（原 10 像素）
- ✅ 添加了数组边界检查，防止崩溃
- ✅ 改进了绘制区域计算，确保条形码居中

### 2. 插入方式改进
由于 Pro/TOOLKIT API 的限制，当前版本采用**半自动插入**方式：

#### 工作流程：
1. 点击 **Generate Barcode** 按钮
2. 插件生成条形码 BMP 图片（保存在临时目录）
3. 如果打开了工程图，会弹出对话框显示：
   - 条形码图片的完整路径
   - 手动插入图片的步骤说明

#### 手动插入步骤：
```
1. 在 Creo 中，点击菜单：Insert > Object > Bitmap Image
2. 浏览到插件显示的图片路径
3. 在工程图上点击放置位置
4. 调整图片大小（如需要）
```

## 为什么不能自动插入图片？

### Pro/TOOLKIT 限制分析

经过深入研究，发现在 Creo 工程图中通过 Pro/TOOLKIT 插入图片有以下限制：

#### 1. **ProDtlnoteCreate** - 只能创建文本注释
- ❌ 不支持直接插入图片
- ❌ 尝试插入会导致 EXCEPTION_ACCESS_VIOLATION 崩溃
- ✅ 只能创建纯文本注释

#### 2. **ProDtlsyminstCreate** - 需要预定义符号
- ⚠️ 需要先创建 `.sym` 符号定义文件
- ⚠️ 符号定义文件需要包含图片引用
- ⚠️ 无法动态创建包含位图的符号
- 🔧 可能的解决方案：预先创建符号模板，但实现复杂

#### 3. **OLE 对象插入** - API 支持有限
- ⚠️ Pro/TOOLKIT 对 OLE 的支持非常有限
- ⚠️ 需要使用 Windows COM 接口
- ⚠️ 在纯 C 环境中实现困难
- ❌ 之前尝试的 COM Bridge 导致崩溃

#### 4. **几何图形转换** - 过于复杂
- ❌ 需要将位图转换为矢量线条
- ❌ 实现复杂度极高
- ❌ 性能问题严重

## 推荐的使用方式

### 方案 A：半自动插入（当前实现）
**优点**：
- ✅ 稳定可靠，不会崩溃
- ✅ 生成高质量条形码
- ✅ 用户可以精确控制位置和大小

**缺点**：
- ⚠️ 需要手动插入图片（2-3 步操作）

**适用场景**：
- 单个或少量条形码插入
- 需要精确控制位置的场景

### 方案 B：批量生成 + 手动插入
使用 **Batch Process** 功能：
1. 点击 **Batch Process** 按钮
2. 插件为工程图中所有零件生成条形码
3. 所有图片保存在临时目录
4. 使用 Creo 的批量插入功能一次性插入

### 方案 C：创建符号模板（未来改进）
**实现思路**：
1. 预先创建一个通用的条形码符号定义 (`.sym` 文件)
2. 符号包含可变文本和图片占位符
3. 插件动态更新符号实例的参数
4. 通过 `ProDtlsyminstCreate` 插入符号

**优点**：
- ✅ 可以实现自动插入
- ✅ 符合 Pro/TOOLKIT 规范

**缺点**：
- ⚠️ 需要额外的符号定义文件
- ⚠️ 实现复杂度较高
- ⚠️ 需要用户配置符号路径

## 使用示例

### 单个条形码生成
```
1. 在 Creo 中打开一个零件或装配体
2. 打开对应的工程图 (.drw)
3. 点击插件菜单：Generate Barcode
4. 查看弹出对话框中的图片路径
5. 按照说明手动插入图片
```

### 批量条形码生成
```
1. 打开包含多个零件的工程图
2. 点击插件菜单：Batch Process
3. 确认要处理的零件数量
4. 所有条形码图片生成到临时目录
5. 使用 Creo 批量插入功能
```

## 条形码质量设置

### 默认设置（已优化）
- **类型**: Code 128
- **宽度**: 400 像素
- **高度**: 120 像素
- **边距**: 20 像素
- **DPI**: 300

### 自定义设置
点击 **Settings** 按钮可以调整：
- 条形码类型（Code 128, Code 39, QR Code 等）
- 尺寸（宽度 50-500，高度 30-300）

### 推荐设置
- **小型标签**: 200x60 像素
- **标准标签**: 400x120 像素（默认）
- **大型标签**: 500x150 像素

## 故障排除

### 问题 1：插件崩溃
**原因**：旧版本尝试自动插入图片导致
**解决**：使用最新版本（2.0），采用半自动插入方式

### 问题 2：找不到图片文件
**原因**：临时目录权限问题
**解决**：检查 `%TEMP%` 目录是否可写

### 问题 3：条形码质量不佳
**原因**：尺寸设置过小
**解决**：使用 Settings 增加宽度和高度

### 问题 4：无法扫描条形码
**原因**：
- 打印分辨率过低
- 条形码尺寸过小
- 模块宽度不足

**解决**：
- 使用至少 300 DPI 打印
- 增加条形码尺寸
- 确保最小模块宽度 ≥ 2 像素

## 技术细节

### 条形码生成算法
- **编码**: Code 128B（支持 ASCII 32-127）
- **校验**: 自动计算校验和
- **格式**: 24 位 BMP（无压缩）
- **质量**: 最小模块宽度 2 像素

### 文件命名规则
```
barcode_<零件名称>.bmp
```
例如：`barcode_PART001.bmp`

### 临时文件位置
```
Windows: %TEMP%\barcode_*.bmp
```

## 未来改进计划

### 短期（v2.1）
- [ ] 添加条形码文本标签显示
- [ ] 支持自定义输出目录
- [ ] 添加图片预览功能

### 中期（v3.0）
- [ ] 实现符号定义方案
- [ ] 支持自动插入（通过符号）
- [ ] 添加批量插入辅助工具

### 长期（v4.0）
- [ ] 支持 QR Code 和 Data Matrix
- [ ] 集成数据库连接
- [ ] 支持自定义条形码内容

## 联系与支持

如有问题或建议，请查看：
- README.md - 基本使用说明
- 使用说明.md - 中文详细文档
- 本文档 - 图片插入专题说明

---

**更新日期**: 2025-12-22  
**版本**: 2.0 (优化版)
